/*! mne - v0.1.0 - 2015-02-23
* https://github.com/agramfort/mne-js
* Copyright (c) 2015 MNEJS contributors; Licensed TBD */
function authenticate(a){return"admin"===a.id.value?"eegdrop"===a.pass.value?(document.getElementById("dropZoneText").style.display="block",document.getElementById("authentication").style.display="none",initializeDragDrop(),initializeFileSelect()):(swal({title:"Error",text:"Invalid Password",type:"error",confirmButtonText:"Try again"}),a.pass.value=""):(swal({title:"Error",text:"Invalid UserID",type:"error",confirmButtonText:"Try again"}),a.id.value="",a.pass.value=""),!1}function RawBDF(a){a._littleEndian=!0,this.info={},this.info.icode=a.scan("uchar",8),parseData(this,a)}function RawEDF(a){a._littleEndian=!0,this.info={},this.info.icode=parseFloat(scanAttribute(a,"uchar",8)),parseData(this,a)}function parse(a){var b=new Scanner(a),c=new RawEDF(b);return c}function loadFiles(a){document.getElementById("dropZoneText").style.display="none",document.getElementById("timeFrameButtons").style.display="block";var b=new FileReader;b.onerror=errorHandler,b.onload=loadHandler(a[0]),b.readAsArrayBuffer(a[0])}function handleFileSelection(a){var b=a.target.files;loadFiles(b)}function handleFileDrag(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}function handleFileDrop(a){a.stopPropagation(),a.preventDefault();var b=a.dataTransfer.files;loadFiles(b)}function isStimChan(a){for(var b=["EDF Annotations","BDF Annotations","Status","Ergo-Left","Ergo-Right"],c=0;c<b.length;c++)if(b[c].match(new RegExp(a,"i")))return!0;return!1}function parseData(a,b){a.info.patientID=scanAttribute(b,"schar",80).trim();{var c=(scanAttribute(b,"schar",80).trim(),scanAttribute(b,"schar",8).trim(),scanAttribute(b,"schar",8).trim(),parseFloat(scanAttribute(b,"schar",8)),b.scan("uchar",44),parseFloat(scanAttribute(b,"char",8)));parseFloat(scanAttribute(b,"char",8))}a.info.nchan=parseFloat(scanAttribute(b,"char",4)),a.info.chanNames=scanStringAttribute2D(b,a.info.nchan,"char",16);scanStringAttribute2D(b,a.info.nchan,"char",80);a.info.units=scanStringAttribute2D(b,a.info.nchan,"char",8);var d=scanFloatAttribute2D(b,a.info.nchan,"char",8),e=scanFloatAttribute2D(b,a.info.nchan,"char",8),f=scanFloatAttribute2D(b,a.info.nchan,"char",8),g=scanFloatAttribute2D(b,a.info.nchan,"char",8);a.info.sfreq=[],a.info.lowpass=[],a.info.highpass=[];var h,i,j;for(h=0;h<a.info.nchan;h++)j=scanAttribute(b,"char",80).trim(),a.info.lowpass[h]=String(j.match(/LP:\s+(\w+)/g)).split(" ").slice(-1)[0],a.info.highpass[h]=String(j.match(/HP:\s+(\w+)/g)).split(" ").slice(-1)[0];for(h=0;h<a.info.nchan;h++)a.info.sfreq[h]=parseFloat(scanAttribute(b,"char",8)),a.info.lowpass[h]=a.info.lowpass[h].localeCompare("NaN")||a.info.lowpass[h].localeCompare("DC")?a.info.sfreq[h]/2:parseFloat(a.info.lowpass[h]),a.info.highpass[h]=a.info.highpass[h].localeCompare("NaN")||a.info.highpass[h].localeCompare("DC")?0:parseFloat(a.info.highpass[h]);for(h=0;h<a.info.nchan;h++)j=b.scan("char",32);var k=[];for(h=0;h<a.info.nchan;h++)k[h]=(e[h]-d[h])/(g[h]-f[h]);var l=[];for(h=0;h<a.info.nchan;h++)l[h]=e[h]-k[h]*g[h];for(a.data=new Array(a.info.nchan),h=0;h<a.info.nchan;h++)a.data[h]=[];var m,n=0,o=0;for(h=0;c>h;h++){for(i=0;i<a.info.nchan;i++){n=a.info.sfreq[i],m=b.scan("sshort",n);for(var p=0;n>p;p++)a.data[i][o+p]=m[p]*k[i]+l[i]}o=n+h*n}for(a.info.channels=[],h=0;h<a.info.nchan;h++){var q=isStimChan(a.info.chanNames[h])?"stim":"eeg";a.info.channels.push({name:a.info.chanNames[h],chanType:q,pos:[1,2,3],isChanGood:!0})}}function scanAttribute(a,b,c){var d,e="";d=a.scan(b,c);for(var f=d.length,g=0;f>g;g++)e+=String.fromCharCode(d[g]);return e}function scanStringAttribute2D(a,b,c,d){for(var e=[],f=0;b>f;f++)e[f]=scanAttribute(a,c,d).trim();return e}function scanFloatAttribute2D(a,b,c,d){for(var e=[],f=0;b>f;f++)e[f]=parseFloat(scanAttribute(a,c,d));return e}function initializeFileSelect(){document.getElementById("fileSelector").addEventListener("change",handleFileSelection,!1)}function initializeDragDrop(){var a=document.body;a.addEventListener("dragover",handleFileDrag,!1),a.addEventListener("drop",handleFileDrop,!1)}function addMarkerListener(a,b){a.text.addEventListener("click",function(){b.colorChannel(a)})}function initiateChanMarker(a){for(var b=[],c=[],d=[],e=Math.min(a.chanPerPage,a.numChan-a.activeChan[0]),f=0;e>f;f++)b[f]=document.getElementById("text-"+f),c[f]=document.getElementById("path-"+f),d[f]=document.getElementById("axis-"+f),addMarkerListener({index:a.activeChan[0]+f,text:b[f],path:c[f],axis:d[f]},a)}function triggerRescaling(a){var b=a.tMin+a.windowLen;b>a.maxDuration?(a.tMin=Math.max(0,a.maxDuration-a.windowLen),a.tMax=a.maxDuration):a.tMax=a.tMin+a.windowLen,a.redrawOnScaling()}function catchButtonClick(a){document.getElementById("button5s").addEventListener("click",function(){a.maxDuration>5&&(a.windowLen=5,triggerRescaling(a))}),document.getElementById("button10s").addEventListener("click",function(){a.maxDuration>10&&(a.windowLen=10,triggerRescaling(a))}),document.getElementById("button15s").addEventListener("click",function(){a.maxDuration>15&&(a.windowLen=15,triggerRescaling(a))})}function catchKeyPress(a){var b={16:!1,38:!1,40:!1,37:!1,39:!1};$(window).bind("mousewheel DOMMouseScroll",function(b){b.shiftKey?b.originalEvent.wheelDelta>0||b.originalEvent.detail<0?a.backward(!0):a.forward(!0):b.originalEvent.wheelDelta>0||b.originalEvent.detail<0?a.upward():a.downward()}),$(document).keydown(function(c){c.keyCode in b&&(b[c.keyCode]=!0,b[16]&&b[38]&&a.incGain(),b[16]&&b[40]&&a.decGain(),b[16]&&b[39]&&a.forward(!1),b[16]&&b[37]&&a.backward(!1),b[39]&&a.forward(!0),b[37]&&a.backward(!0),b[38]&&!b[16]&&a.upward(),b[40]&&!b[16]&&a.downward())}).keyup(function(a){a.keyCode in b&&(b[a.keyCode]=!1)})}function RawPlotter(a,b,c){c||(c={}),this.raw=a,this.selector=b,this.options=c,this.data=this.raw.data,this.channels=this.raw.info.channels,this.chanNames=this.raw.info.chanNames,this.numChan=this.raw.info.nchan,this.sfreq=this.raw.info.sfreq,this.margin={top:0,right:0,bottom:25,left:70},this.chanPerPage=c.chanPerPage||Math.min(15,this.numChan),this.maxDuration=this.data[0].length/this.sfreq[0];var d=this.maxDuration<10?5:10;this.windowLen=c.windowLen||d,this.isSmallDuration=this.maxDuration<5?!0:!1,this.forwardLimit=this.maxDuration,this.backwardLimit=0,this.upLimit=this.chanPerPage,this.downLimit=this.numChan-this.chanPerPage-1,this.tMin=0,this.tMax=this.windowLen,this.currentSliderPos=0,this.gain=[];for(var e=0;e<this.numChan;e++)this.gain.push(1);for(this.gainMultiplier=1.5,this.activeChan=[],e=0;e<this.chanPerPage;e++)this.activeChan.push(e);for(this.numBadChan=0,e=0;e<this.numChan;e++)"stim"===this.channels[e].chanType&&(this.numBadChan+=1);this.badChannelColor="rgba(145, 145, 145, 0.30)",this.sampleChunkSize=Math.round(this.data[0].length/2e3),this.numSampleChunks=Math.round(this.data[0].length/this.sampleChunkSize),this.downSampleSumData()}var loadHandler=function(a){return function(b){var c=b.target.result,d=parse(c);d.info.fileName=a.name;var e=new RawPlotter(d,"#graph");document.getElementById("graph").innerHTML="",e.setup(),e.draw(),catchKeyPress(e),e.isSmallDuration||catchButtonClick(e),e.redrawOnResize(),e.drawSlider(),e.plotSumData()}},errorHandler=function(a){window.console.log("Error:"+a.target.error.code)},Scanner=function(a){this._data=a,this._dataPointer=0,this._nativeLittleEndian=new Int8Array(new Int16Array([1]).buffer)[0]>0,this._littleEndian=!1};Scanner.prototype.scan=function(a,b){"undefined"==typeof b&&(b=1);var c=1,d=Uint8Array;switch(a){case"uchar":break;case"schar":d=Int8Array;break;case"ushort":d=Uint16Array,c=2;break;case"sshort":d=Int16Array,c=2;break;case"uint":d=Uint32Array,c=4;break;case"sint":d=Int32Array,c=4;break;case"float":d=Float32Array,c=4;break;case"float64":d=Float64Array,c=8}var e=new d(this._data.slice(this._dataPointer,this._dataPointer+=b*c));return this._nativeLittleEndian!==this._littleEndian&&(e=this.flipEndianness(e,c)),1===b?e[0]:e},Scanner.prototype.flipEndianness=function(a,b){for(var c=new Uint8Array(a.buffer,a.byteOffset,a.byteLength),d=0;d<a.byteLength;d+=b)for(var e=d+b-1,f=d;e>f;e--,f++){var g=c[f];c[f]=c[e],c[e]=g}return a},RawPlotter.prototype.setup=function(){this.svgWidth=document.getElementById("graph").clientWidth,this.width=this.svgWidth-this.margin.left-this.margin.right,this.svgHeight=document.getElementById("graph").clientHeight,this.height=this.svgHeight-this.margin.top-this.margin.bottom,this.plotSpacing=this.height/this.chanPerPage,this.textFont=this.svgHeight/40,document.getElementById("plotInfo").setAttribute("style","font-size:"+this.textFont+"px");var a=.0086,b=this.svgHeight*a;document.getElementById("interaction").setAttribute("style","margin-bottom:"+b+"em"),this.yOffset=[],this.textOffsetArr=[];for(var c=this.svgHeight/40,d=0;d<this.chanPerPage;d++)this.yOffset.push(d*this.plotSpacing),this.textOffsetArr.push(this.yOffset[d]+c);var e=d3.scale.linear().domain([0,this.windowLen]).range([0,this.width]),f=d3.scale.linear().domain([d3.min(this.data[0]),d3.max(this.data[0])]).range([this.height/this.chanPerPage,0]);this.line=d3.svg.line().x(function(a,b){return e(b/this.sfreq[0])}).y(function(a){return f(a)}),this.graph=d3.select(this.selector).append("svg").attr("width",this.svgWidth).attr("height",this.svgHeight).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")},RawPlotter.prototype.draw=function(){{var a=this.dataSliceTime(this.dataSliceChan());this.chanNames.slice(this.activeChan[0],this.activeChan[this.chanPerPage])}this.graph.selectAll("text").remove(),this.graph.selectAll("path").remove();var b=Math.min(this.chanPerPage,this.numChan-this.activeChan[0]),c=this.svgWidth/43;for(i=0;i<b;i++){for(var d=[],e=0;e<a[i].length;e++)a[i][e]*=this.gain[i],d.push(0);this.graph.append("text").attr("id","text-"+i).attr("transform","translate(-"+c+","+this.textOffsetArr[i]+")").text(this.channels[i+this.activeChan[0]].name).style({fill:this.channels[i+this.activeChan[0]].isChanGood?"black":this.badChannelColor,"font-size":this.textFont+"px"}),this.graph.append("path").attr("id","path-"+i).attr("transform","translate(0,"+this.yOffset[i]+")").style({stroke:this.channels[i+this.activeChan[0]].isChanGood?"steelblue":this.badChannelColor}).attr("d",this.line(a[i])),this.graph.append("path").attr("id","axis-"+i).attr("transform","translate(0,"+this.yOffset[i]+")").style({stroke:this.channels[i+this.activeChan[0]].isChanGood?"grey":this.badChannelColor}).attr("d",this.line(d))}var f=document.getElementById("plotInfo");f.innerHTML="<i>File Name:</i> <b>"+this.raw.info.fileName+"</b> / <i>Total Length:</i> <b>"+this.maxDuration+"s</b> / <i>Time Frame: </i><b>"+this.tMin+"s - "+this.tMax+"s</b>",initiateChanMarker(this)},RawPlotter.prototype.drawSlider=function(){function a(){var a=g.extent()[0];if(d3.event.sourceEvent){var d=a;a=Math.round(f.invert(d3.mouse(this)[0])),a=Math.min(Math.max(0,a-Math.round(b.windowLen/2)),c),g.extent([a,a]),d===a||this.isSmallDuration||b.redrawOnSlide(a)}l.attr("x",f(a))}var b=this,c=this.maxDuration-this.windowLen,d=this.maxDuration,e=10;this.sliderSvgWidth=this.svgWidth+10,this.sliderSvgHeight=this.svgHeight/10;var f=d3.scale.linear().domain([0,d]).range([0,this.width]).clamp(!0),g=d3.svg.brush().x(f).extent([0,0]).on("brush",a);this.brush=g;var h=d3.select("#sliderDiv").append("svg").attr("width",this.sliderSvgWidth).attr("height",this.sliderSvgHeight).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")");h.append("g").attr("class","x axis").attr("transform","translate(0,"+this.sliderSvgHeight/2+")").call(d3.svg.axis().scale(f).orient("bottom").ticks(0).tickSize(0)).select(".domain").attr("class","halo"),this.slider=h.append("g").attr("class","slider").call(g),this.slider.select(".background").attr("height",this.sliderSvgHeight/2).style("cursor","move");var i=(this.sliderSvgHeight-e)/2,j=this.svgWidth-this.margin.left,k=Math.min(j,this.windowLen*j/this.maxDuration),l=this.slider.append("rect").attr("class","handle").attr("width",k).attr("height",e).attr("transform","translate(0,"+i+")")},RawPlotter.prototype.moveSlider=function(a){(this.currentSliderPos!==this.tMin||a)&&(this.slider.call(this.brush.event).call(this.brush.extent([this.tMin,this.tMin])).call(this.brush.event),this.currentSliderPos=this.tMin)},RawPlotter.prototype.plotSumData=function(){var a=d3.scale.linear().domain([0,this.maxDuration]).range([0,this.width]),b=d3.scale.linear().domain([d3.min(this.sumData),d3.max(this.sumData)]).range([this.height/this.chanPerPage,0]),c=this.sfreq[0]/this.sampleChunkSize;this.sumArea=d3.svg.area().x(function(b,d){return a(d/c)}).y0(this.height/this.chanPerPage).y1(function(a){return b(a)});var d=this.svgHeight/10;this.sumPlotSVG=d3.select("#sumPlot").append("svg").attr("width",this.svgWidth).attr("height",d).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.sumLine=d3.svg.line().x(function(b,d){return a(d/c)}).y(function(a){return b(a)}),this.sumPlotSVG.append("path").datum(this.sumData).attr("class","area").attr("d",this.sumArea),this.sumPlotSVG.append("path").attr("id","sumPath").style({stroke:"black"}).attr("d",this.sumLine(this.sumData))},RawPlotter.prototype.redrawPlotSumData=function(a,b){if("stim"!==this.channels[a].chanType){var c;if(this.numBadChan===this.numChan)for(c=0;c<this.numSampleChunks;c++)this.sumData[c]=0;else{var d,e,f,g,h;for(c=0;c<this.numSampleChunks;c++){d=0,f=c*this.sampleChunkSize,g=f,h=f+this.sampleChunkSize;for(var i=g;h>i;i++)d+=Math.pow(this.data[a][i],2);e=Math.pow(this.sumData[c],2),b?e+=d/this.sampleChunkSize:e-=d/this.sampleChunkSize,this.sumData[c]=Math.sqrt(Math.max(0,e))}}document.getElementById("sumPlot").innerHTML="",this.plotSumData()}},RawPlotter.prototype.forward=function(a){if(!this.isSmallDuration){var b=a?1:this.windowLen-1;this.tMax+b>this.maxDuration?(this.tMax=this.maxDuration,this.tMin=Math.max(0,this.maxDuration-this.windowLen),this.draw(),this.moveSlider()):this.tMax<this.forwardLimit&&(this.tMin+=b,this.tMax+=b,this.draw(),this.moveSlider())}},RawPlotter.prototype.backward=function(a){if(!this.isSmallDuration){var b=a?1:this.windowLen-1;this.tMin-b<0?(this.tMin=0,this.tMax=Math.min(this.windowLen,this.maxDuration),this.draw(),this.moveSlider()):this.tMin>this.backwardLimit&&(this.tMin-=b,this.tMax-=b,this.draw(),this.moveSlider())}},RawPlotter.prototype.upward=function(){if(this.activeChan[0]>=this.upLimit){for(var a=0;a<this.chanPerPage;a++)this.activeChan[a]-=this.chanPerPage;this.draw()}},RawPlotter.prototype.downward=function(){var a=this.activeChan.slice(-1)[0];if(a<=this.downLimit||a<=this.numChan){for(var b=0;b<this.chanPerPage;b++)this.activeChan[b]+=this.chanPerPage;this.draw()}},RawPlotter.prototype.incGain=function(){for(var a=0;a<this.numChan;a++)this.gain[a]*=this.gainMultiplier;this.draw()},RawPlotter.prototype.decGain=function(){for(var a=0;a<this.numChan;a++)this.gain[a]/=this.gainMultiplier;this.draw()},RawPlotter.prototype.dataSliceTime=function(a){for(var b=[],c=Math.min(this.chanPerPage,this.numChan-this.activeChan[0]),d=0;c>d;d++){var e=this.sfreq[this.activeChan[d]];b.push(a[d].slice(this.tMin*e,this.tMax*e))}return b},RawPlotter.prototype.dataSliceChan=function(){return this.data.slice(this.activeChan[0],this.activeChan[this.chanPerPage])},RawPlotter.prototype.redrawOnResize=function(){var a=this;window.onresize=function(){document.getElementById("graph").innerHTML="",document.getElementById("sliderDiv").innerHTML="",document.getElementById("sumPlot").innerHTML="",a.setup(),a.draw(),a.drawSlider(),a.moveSlider(!0),a.plotSumData()}},RawPlotter.prototype.redrawOnScaling=function(){document.getElementById("graph").innerHTML="",document.getElementById("sliderDiv").innerHTML="",this.setup(),this.draw(),this.drawSlider(),this.moveSlider(!0)},RawPlotter.prototype.redrawOnSlide=function(a){this.tMin=a,this.tMax=a+this.windowLen,this.draw(),this.moveSlider()},RawPlotter.prototype.colorChannel=function(a){this.channels[a.index].isChanGood=!this.channels[a.index].isChanGood,this.channels[a.index].isChanGood?(a.text.setAttribute("style","fill:black"),a.path.setAttribute("style","stroke:steelblue"),a.axis.setAttribute("style","stroke:grey"),"stim"!==this.channels[a.index].chanType&&(this.numBadChan-=1),this.redrawPlotSumData(a.index,!0)):(a.text.setAttribute("style","fill:"+this.badChannelColor),a.path.setAttribute("style","stroke:"+this.badChannelColor),a.axis.setAttribute("style","stroke:"+this.badChannelColor),"stim"!==this.channels[a.index].chanType&&(this.numBadChan+=1),this.redrawPlotSumData(a.index,!1))},RawPlotter.prototype.downSampleSumData=function(){for(var a,b,c,d=[],e=0;e<this.numSampleChunks;e++){for(d.push(0),a=e*this.sampleChunkSize,b=a,c=a+this.sampleChunkSize,i=0;i<this.numChan;i++)if("stim"!==this.channels[i].chanType)for(var f=b;c>f;f++)d[e]+=Math.pow(this.data[i][f],2);d[e]=Math.sqrt(d[e]/this.sampleChunkSize)}this.sumData=d.slice()};